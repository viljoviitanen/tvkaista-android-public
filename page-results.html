<!-- Copyright (c) 2014-2015 Viljo Viitanen -->

<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<polymer-element name="page-results" attributes="r">
<template>
<link rel="stylesheet" href="style.css" type="text/css">
<style>
core-item {
  white-space: normal;
}
core-item[desc] {
  font-size: small; 
  padding-left: 0.5em;
}
.submenu {
  background-color: white;
}
</style>
<paper-toast id="toast"></paper-toast>
<core-ajax id="menuajax" url="/menu" handleAs="json" method="POST" on-core-response={{ajaxresponse}} on-core-error={{ajaxerror}}>
</core-ajax>
<core-menu id="menu">
 <core-item id="loading">
   <paper-spinner active style="margin-left: auto; margin-right: auto;"></paper-spinner>
 </core-item>
  
  <template id="results" repeat="{{r in r}}">
   <core-item lines>
    <paper-item flex noink id="p{{r.id}}"><a on-click="{{togglesubmenu}}" data-id="{{r.id}}"
    >{{r.title}} <span class="right">{{r.time}}</span></a></paper-item>
   </core-item>
   <template if="{{r.active}}">
   <div class="submenu">
     <paper-menu-button style="float: right;">
	<paper-icon-button icon="more-vert" style="color: #aaa"></paper-icon-button>
	<paper-dropdown class="dropdown" halign="right">
	  <core-menu class="menu">
	      <paper-item data-id="{{r.id}}" on-click="{{addlist}}">Lisää listalle</paper-item>
	      <paper-item data-id="{{r.id}}" on-click="{{removelist}}">Poista listalta</paper-item>
	      <paper-item data-id="{{r.id}}" on-click="{{addseries}}">Lisää sarjoihin</paper-item>
	  </core-menu>
	</paper-dropdown>
     </paper-menu-button>
     <core-item desc flex>{{r.ch}} {{r.time}} {{r.dur}}<br>{{r.desc}}</core-item>
     <core-item style="clear: both;">
      <video id="v" controls poster="{{r.thumb}}" preload="none" src="{{r.purl}}" onplay="ga('send','event','play')">
     </core-item>
   </div>
  </template>
  </template>
</core-menu>
</template>
  <script>
    Polymer('page-results', {
      msg: function(m) {
        this.$.loading.innerHTML=m;
      },
      stop: function() {
        this.$.loading.hidden=true;
      },
      togglesubmenu: function(event,detail,sender) {
	for (i in this.r) {
	  if (this.r[i].id==sender.dataset.id) {
	    this.r[i].active=!this.r[i].active;
	  }
	  else {
	    this.r[i].active=false;
	  }
        }
      },
      addlist: function(event,detail,sender) {
	console.log("addlist");
	console.log(sender.dataset.id);
	this.$.menuajax.params={"token":random,"id":sender.dataset.id,"op":2};
	this.$.toast.text="Ohjelma lisätty listalle";
	this.$.menuajax.go();
      },
      removelist: function(event,detail,sender) {
	console.log("removelist");
	console.log(sender.dataset.id);
	this.$.menuajax.params={"token":random,"id":sender.dataset.id,"op":1};
	this.$.toast.text="Ohjelma poistettu listalta";
	this.$.menuajax.go();
      },
      //removing the series ain't here 'cos it needs the seasonpass id, not program id
      addseries: function(event,detail,sender) {
	console.log("addseries");
	console.log(sender.dataset.id);
	this.$.menuajax.params={"token":random,"id":sender.dataset.id,"op":4};
	this.$.toast.text="Ohjelma lisätty sarjoihin";
	this.$.menuajax.go();
      },
      ajaxerror: function(event) {
	console.log("in ajaxerror");
	this.$.toast.text="Toiminto epäonnistui!"
	this.$.toast.show();
      },
      ajaxresponse: function(event) {
	console.log("in ajaxresponse");
	this.$.toast.show();
	sessionStorage.removeItem("/seasonpasses?param=*");
	sessionStorage.removeItem("/playlist?param=");
      },
    });
  </script>
</polymer-element>
